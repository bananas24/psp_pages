import{_ as l}from"./ProducerConsumer.8367c5c5.js";import{_ as r,r as t,o as u,c as d,d as a,a as n,w as o,b as s,f as m}from"./app.108f91ed.js";const k={},v=n("h1",{id:"_3-3-producer-consumer-model",tabindex:"-1"},"3.3 Producer-Consumer model",-1),h={class:"table-of-contents"},b=s("3.3.1. Communication & synchronization template"),g=s("3.3.2 Main class"),w=s("3.3.3 Producer & Consumer classes"),y=s("3.3.4 Shared class. Threads synchronization"),f=n("h2",{id:"_3-3-1-communication-synchronization-template",tabindex:"-1"},"3.3.1. Communication & synchronization template",-1),_=n("p",null,[s("Threads synchronization means having tools to avoid "),n("code",null,"starvation"),s(" (threads lock), "),n("code",null,"deadlocks"),s(" (when a condition can never be satisfied) and to ensure shared resources are well managed by concurrent threads access.")],-1),C=s("The Producer-Consumer problem is a classic example of a multi-threaded synchronization problem. Let's go into the usage of the shared resources by using this famous algorithm. "),j={href:"https://es.wikipedia.org/wiki/Problema_productor-consumidor",target:"_blank",rel:"noopener noreferrer"},x=s("Wikipedia"),z=s("."),P=m('<p>Without thread control mechanism we already know that problems will rise up randomly:</p><ul><li>Consumer can get elements more than once, exceeding the stock (banc account balance under 0, reader reading a book before it is finished).</li><li>Producers can be quicker than Consumer and produce more information than the system can get, making data loose.- Consumer can be quicker than the Producer and can get more than once the same value, having inconsistent systems.</li></ul><p>That&#39;s all we know as <code>race conditions</code>.</p><p>The following code template repeats over and over again for almos all activities we are going to work on. That&#39;s what we call the Producer-Consumer model.</p><p><img src="'+l+`" alt="Producer-Consumer"></p><p>This model is based on three classes, but depending on the problem we can have only producers or just consumers.</p><p>::: info Model as a design pattern It&#39;s very important to fit our code into the model schema</p><p>This is like a puzzle where we have to adjust the problem solution. Sometimes we won&#39;t have a producer, other there will be no consumer. Maybe we will use the wait condition only in one of them.</p><p>We shouldn&#39;t add or modify the way the schema is presented, all parts must fit into the given model. :::</p><h2 id="_3-3-2-main-class" tabindex="-1">3.3.2 Main class</h2><blockquote><p>Main class will always have the same estructure. Following code can be used asa a template.</p></blockquote><p>Here we instantiate the shared object to be used by producers&amp;consumers. This is the object that will hold communication, synchronization and information exchange between threads.</p><p>In this example it is an object, but we can use a Collection or any other data structure useful for thread to share information and synchronize.</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClasePrincipal</span> <span class="token punctuation">{</span> 

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>    
        <span class="token class-name">ClaseCompartida</span> objetoCompartido <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjetoCompartido</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Productor</span> p  <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Productor</span><span class="token punctuation">(</span>objetoCompartido<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Consumidor</span> c  <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Consumidor</span><span class="token punctuation">(</span>objetoCompartido<span class="token punctuation">)</span><span class="token punctuation">;</span>
        productor<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumidor<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// No es obligatorio, pero en ocasiones puede interesar que la ClasePrincipal</span>
        <span class="token comment">// espere a que acaben los hilos</span>
        productor<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumidor<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Acciones a realizar una vez hayan acabado el productor y el consumidor</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="highlight-lines"><br><br><br><div class="highlight-line">\xA0</div><div class="highlight-line">\xA0</div><div class="highlight-line">\xA0</div><br><br><br><br><br><br><br><br><br><br><br><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container warning"><p class="custom-container-title">Number of producer &amp; consumer threads</p><p>In the previous code we have created and launched one of each, but it has not to be like that.</p><p>Each problem to solve will need a different number of <em>Productores</em> and <em>Consumidores</em>, that will be instantiated and launched in the main method or in any other complementary method in the class in charge of thread management.</p><p>In the same way it&#39;s on the problem if the main thread has to wait for the others to finish or not.</p></div><div class="pagebreak"></div><h2 id="_3-3-3-producer-consumer-classes" tabindex="-1">3.3.3 Producer &amp; Consumer classes</h2><blockquote><p>Both <strong>Producer</strong> and <strong>Consumer</strong> classes will call methods in the shared object.</p></blockquote><p>In both classes, the application logic will be developed inside <strong>run</strong> method. This will be done basically accessing the shared object, calling its synchronized methods, modifying its properties and updating the object state to control its functionality.</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Consumidor</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">ClaseCompartida</span> objetoCompartido<span class="token punctuation">;</span>
    
    <span class="token class-name">Consumidor</span><span class="token punctuation">(</span><span class="token class-name">ClaseCompartida</span> objetoCompartido<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>objetoCompartido <span class="token operator">=</span> objetoCompartido<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// La ejecuci\xF3n del m\xE9todo run estar\xE1 normalmente gestionada por un bucle</span>
        <span class="token comment">// que controlar\xE1 el ciclo de vida del hilo y se adaptar\xE1 al problema.</span>
        <span class="token comment">// En el caso de simulaciones se har\xE1n esperas proporcionales.</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// C\xF3digo que hace el hilo consumidor</span>
            objetoCompartido<span class="token punctuation">.</span><span class="token function">accionDeConsumir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// La espera es opcional</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">1000</span><span class="token operator">+</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token punctuation">}</span>         
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>    
</code></pre><div class="highlight-lines"><br><div class="highlight-line">\xA0</div><br><br><div class="highlight-line">\xA0</div><br><br><br><br><br><br><br><br><br><div class="highlight-line">\xA0</div><br><br><br><br><br><br><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Productor</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">ClaseCompartida</span> objetoCompartido<span class="token punctuation">;</span>
    
    <span class="token class-name">Productor</span><span class="token punctuation">(</span><span class="token class-name">ClaseCompartida</span> objetoCompartido<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>objetoCompartido <span class="token operator">=</span> objetoCompartido<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// La ejecuci\xF3n del m\xE9todo run estar\xE1 normalmente gestionada por un bucle</span>
        <span class="token comment">// que controlar\xE1 el ciclo de vida del hilo y se adaptar\xE1 al problema.</span>
        <span class="token comment">// En el caso de simulaciones se har\xE1n esperas proporcionales.</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// C\xF3digo que hace el hilo productor</span>
            objetoCompartido<span class="token punctuation">.</span><span class="token function">accionDeProducir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// La espera es opcional</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">1000</span><span class="token operator">+</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token punctuation">}</span>         
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> 
</code></pre><div class="highlight-lines"><br><div class="highlight-line">\xA0</div><br><br><div class="highlight-line">\xA0</div><br><br><br><br><br><br><br><br><br><div class="highlight-line">\xA0</div><br><br><br><br><br><br><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="pagebreak"></div><h2 id="_3-3-4-shared-class-threads-synchronization" tabindex="-1">3.3.4 Shared class. Threads synchronization</h2><p>This model is completed with the shared object class. Here we provide methods to be used by both Producers and Consumers. Furthermore, this class must be thread-safe to avoid <code>race conditions</code>.</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">ClaseCompartida</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> valorAccedidoSimultaneamente<span class="token punctuation">;</span>
    
    <span class="token class-name">ClaseCompartida</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Se inicializa el valor</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>valorAccedidoSimultaneamente <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">accionDeConsumir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Si no se cumple la condici\xF3n para poder consumir, el consumidor debe esperar</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">valorAccedidoSimultaneamente</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Consumidor espera...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Si es necesario se realizar\xE1 la gesti\xF3n de la Interrupci\xF3n</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
                
        <span class="token comment">// Cuando se ha cumplido la condici\xF3n para consumir, el consumidor consume</span>
        valorAccedidoSimultaneamente<span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Se ha consumido: %d.\\n&quot;</span><span class="token punctuation">,</span> valorAccedidoSimultaneamente<span class="token punctuation">)</span><span class="token punctuation">;</span>        

        <span class="token comment">// Se activa a otros hilos que puedan estar en espera</span>
        <span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> accionDeProducir <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Si no se cumple la condici\xF3n para poder producir, el productor debe esperar</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">valorAccedidoSimultaneamente</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Productor espera...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Si es necesario se realizar\xE1 la gesti\xF3n de la Interrupci\xF3n                </span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">// Cuando se ha cumplido la condici\xF3n para producir, el productor produce</span>
        valorAccedidoSimultaneamente<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;Se ha producido: %d.\\n&quot;</span><span class="token punctuation">,</span> valorAccedidoSimultaneamente<span class="token punctuation">)</span><span class="token punctuation">;</span>        

        <span class="token comment">// Se activa a otros hilos que puedan estar en espera</span>
        <span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="highlight-lines"><br><div class="highlight-line">\xA0</div><br><br><br><br><br><br><div class="highlight-line">\xA0</div><br><div class="highlight-line">\xA0</div><br><br><div class="highlight-line">\xA0</div><br><br><br><br><br><br><div class="highlight-line">\xA0</div><br><br><br><div class="highlight-line">\xA0</div><br><br><div class="highlight-line">\xA0</div><br><div class="highlight-line">\xA0</div><br><br><div class="highlight-line">\xA0</div><br><br><br><br><br><br><div class="highlight-line">\xA0</div><br><br><br><div class="highlight-line">\xA0</div><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>What&#39;s interesting from above code is the pair <code>wait / notifyAll</code> together with the <code>synchronized</code> modifier.</p><ul><li>A call to a <strong>synchronized</strong> method makes it be run if and only if there in no other thread running another <strong>synchronized</strong> method <code>for the same object instance</code>. If that happens the thread trying to accesss the synchronized block will be locked until another thread calls <strong>notifyAll</strong> or leaves the synchronized block. Then all threads waiting for the monitor are awaken but only one of them can own the monitor an run the synchronized block.</li><li>Simply put, calling <strong>wait()</strong> forces the current thread to wait until some other thread invokes notify() or notifyAll() on the same object.For this, the current thread must own the object&#39;s monitor, because the monitor is released.</li><li>We use the notify/notifyAll method for waking up threads that are waiting for an access to this object&#39;s monitor. All awaken threads are automatically sent onto the monitor queue together with all threads already waiting to own the monitor. All threads, once the monitor is owned by them, will start running the synchronized code o will continue running the next sentence after the wait call.</li></ul><blockquote><p>With <strong>wait</strong>, <strong>notifyAll</strong> methods and <strong>synchronized</strong> code blocks we can avoid concurrent threads to modify a shared variable. <em>(lines 21 and 40 from previous code)</em>.</p></blockquote><p>::: info Producer-Consumer model summary Original Producer-Consumer works with a buffer where the Producer puts information and the Consumer gets it from the buffer. The buffer can never be overflown and it cannot be read if it is empty.</p><p>Our example has been simplified by using a int variable that has to be always in the range [0.10]</p><p>This variables can be of any type and the class code will be different depending on it. It must be valid for the problem and the data type control.</p><p>Finally, conditions or states added for waiting and updates will be what us, as programmers, must code in order to make it work as specified by problems requirements. :::</p>`,32);function S(q,T){const i=t("DownloadPDF-component"),c=t("DocumentCover-component"),e=t("router-link"),p=t("ExternalLinkIcon");return u(),d("div",null,[a(i),a(c,{titulo:"3.3 Producer-Consumer model"}),v,n("nav",h,[n("ul",null,[n("li",null,[a(e,{to:"#_3-3-1-communication-synchronization-template"},{default:o(()=>[b]),_:1})]),n("li",null,[a(e,{to:"#_3-3-2-main-class"},{default:o(()=>[g]),_:1})]),n("li",null,[a(e,{to:"#_3-3-3-producer-consumer-classes"},{default:o(()=>[w]),_:1})]),n("li",null,[a(e,{to:"#_3-3-4-shared-class-threads-synchronization"},{default:o(()=>[y]),_:1})])])]),f,_,n("p",null,[C,n("a",j,[x,a(p)]),z]),P])}const D=r(k,[["render",S],["__file","producer-consumer.html.vue"]]);export{D as default};
